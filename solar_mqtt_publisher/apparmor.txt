#include <tunables/global>

profile hassio-solar_mqtt_publisher flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/hassio>

  file,
  signal (send) set=(kill,term,int,hup,cont),

  # s6 / shell / scripts
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /app/run.sh ix,

  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # Add-on data
  /data/** rw,

  # Allow network here too (helps during early bootstrap)
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,

  # Transition to the appâ€™s subprofile
  /app/SolarMqtt cx -> SolarMqtt,


  profile SolarMqtt flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/hassio>
    #include <abstractions/nameservice>
    #include <abstractions/ssl_certs>

    # Receive signals from parent
    signal (receive) peer=hassio-solar_mqtt_publisher,

    # Executable & config
    /app/SolarMqtt mr,
    /app/default/options.json r,
    /data/** rw,

    # Native loader + libs (Alpine musl, single-file needs mmaps)
    /lib/** mr,
    /usr/lib/** mr,

    # Time/identity
    /etc/localtime r,
    /etc/machine-id r,

    # TLS/DNS essentials (be explicit)
    /etc/ssl/** r,
    /etc/ca-certificates/** r,
    /usr/share/ca-certificates/** r,
    /etc/ssl/openssl.cnf r,
    /etc/hosts r,
    /etc/resolv.conf r,
    /etc/nsswitch.conf r,
    /etc/gai.conf r,
    /usr/share/zoneinfo/** r,
    /run/** r,

    # Devices & logs
    /dev/urandom r,
    /dev/null rw,
    owner /dev/stdout w,
    owner /dev/stderr w,

    # Temp (extract/scratch)
    /tmp/** rwk,

    # Network (just what you need)
    network inet stream,
    network inet6 stream,
    network inet dgram,
    network inet6 dgram,

    # Optional diagnostics
    /proc/net/** r,
    /proc/sys/net/** r,

    # Guardrails (adjust if you actually need these)
    deny /config/** rwkl,
    deny /root/** rwkl,
  }
}
